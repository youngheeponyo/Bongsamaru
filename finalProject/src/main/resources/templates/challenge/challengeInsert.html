<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
<meta charset="UTF-8">
<title>챌린지 등록</title>

<style>
textarea {
	width: 100%;
	height: 100px;
	resize: none;
}
p {
	font-size: 15px;
	font-weith:800;
	color:#689f38;
}
h3{
	color:#689f38;
}
</style>
</head>

<body>

	<section layout:fragment="content">
	<div th:insert="~{banner/fac::banner}"></div>	
		<h2 class="text-center mb-4">챌린지 등록</h2>
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-md-10" style="background-color:#689f38">
			
					<form name="insertForm" action="challengeInsert" method="post" enctype="multipart/form-data" >
						<div class="card">
							<div class="card-body" style="background-color:fff">
							<h3>챌린지 제목</h3>
							<div class="form-group">
									<input class="form-control" type="text" name="title" placeholder="챌린지 제목을 작성해 주세요" required>
								</div>
								<div class="col-lg-12 feature-img">
								<div class="row justify-content-center" >
								<div class="col-6" >
								
									<div class="image-container" id="image-container0">
									<div class="showimg-container">
										<img id="imagePreview" src="/image/no이미지.png"
											style="width: 420px; height: 200px;">
									
									</div>
									<p>"메인 이미지 들어갈 자리입니다"</p>
									</div>
									
									</div>
								</div>
								</div>
								
									<h3>챌린지일시</h3>
								<div class="form-group">
									<div class="row">
										<div class="col">
											<input type="date" class="form-control" id="start" name="regDate" >
											<small class="text-muted">챌린지 시작일</small>
										</div>
										<div class="col">
											<input type="date" class="form-control" name="endDate" >
											<small class="text-muted">챌린지 종료일 (오늘부터 최소 한 달, 최대 6개월까지)</small>
										</div>
									</div>
								</div>
								<h3>행동이유</h3>
								<div class="row">
								<div class="col-6">
									<div class="form-group">
									
									<div class="image-container" id="image-container1">
									<div class="showimg-container">
										<img id="imagePreview" src="/image/no이미지.png"
											style="width: 420px; height: 200px;">
									
									</div>
									<p>"행동이유 들어갈 자리입니다"</p>
									</div>
									</div>
								</div>
								<div class="col-6">
									<div class="form-group">
									<div class="image-container" id="image-container2">
									<div class="showimg-container">
										<img id="imagePreview" src="/image/no이미지.png"
											style="width: 420px; height: 200px;">
									
									</div>
									<p>"행동이유 들어갈 자리입니다"</p>
									</div>
									</div>
								</div>
								</div>
								
								<div class="form-group">
									<textarea class="form-control" name="actionReason" placeholder="행동이유를 작성해 주세요" required></textarea>
								</div>
								<h3>기대효과</h3>
								<div class="row">
								<div class="col-6">
									<div class="form-group">
									<div class="image-container" id="image-container3">
									<div class="showimg-container">
										<img id="imagePreview" src="/image/no이미지.png"
											style="width: 420px; height: 200px;">
									
									</div>
									<p>"기대효과이미지 들어갈 자리입니다"</p>
									</div>
									</div>
								</div>
								<div class="col-6">
									<div class="form-group">
								<div class="image-container" id="image-container4">
									<div class="showimg-container">
										<img id="imagePreview" src="/image/no이미지.png"
											style="width: 420px; height: 200px;">
								
									</div>
									<p>"기대효과 이미지 들어갈 자리입니다"</p>
									</div>
									</div>
								</div>
								</div>
								<div class="form-group">
									<textarea class="form-control" name="expImpact" placeholder="기대효과를 작성해 주세요" required></textarea>
								</div>
								
								<h3>자유내용</h3>
								<div class="form-group">
									<textarea class="form-control" name="content" placeholder="그 외 내용(인증안되는 사례 등)을 자유롭게 작성해 주세요" required></textarea>
								</div>
								<div class="file-input-container">
									<input class="form-control file-input" id="imageInput" name="uploadFiles" type="file" multiple>
									<label for="imageInput" class="custom-file-label"></label>
									<span id="file-chosen"></span>
									</div>
								<h3>HOW TO</h3>
								<div class="form-group">
									<input type="text" class="form-control" name="partMethod1" placeholder="방법 1을 입력해주세요" required>
								</div>
								
								
								<div class="form-group">
									<input type="text" class="form-control" name="partMethod2" placeholder="방법 2을 입력해주세요" required>
								</div>
									
								<div class="text-center">
								<br>
									<button type="submit" class="btn btn-primary">작성하기</button>
								<br>	
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
		<script th:inline="javascript">
			//시작날짜 오늘로 설정
			document.getElementById('start').value = new Date().toISOString().substring(0, 10);			
			$('input[name=regDate]').attr("readonly", true);

			//종료일자 6개월 제한
			let minDate = new Date();
			let maxDate = new Date();

			minDate.setMonth(minDate.getMonth() + 1);
			let startDate = minDate.toISOString().substring(0, 10);
			maxDate.setMonth(maxDate.getMonth() + 6);
			let endDate = maxDate.toISOString().substring(0, 10);

			$('input[name=endDate]').prop("min", startDate);
			$('input[name=endDate]').prop("max", endDate);
			
		//form 등록관련	
			$('form[name="insertForm"]').on('submit', challengeInsert);

			function challengeInsert(event) {
				event.preventDefault();

				let title = $('[name="title"]');
				let actionReason = $('[name="actionReason"]');
				let impact = $('[name="expImpact"]');
				let content = $('[name="content"]');
				let start = $('[name="regDate"]');
				let end = $('[name="endDate"]');
				let howTo1 = $('[name="partMethod1"]');
				let howTo2 = $('[name="partMethod2"]');

				if (title.val() == '') {
					alert('제목이 입력되지 않았습니다');
					title.focus();
					return;
				}
				if (actionReason.val() == '') {
					alert('행동이유가 입력되지 않았습니다');
					actionReason.focus();
					return;
				}
				if (impact.val() == '') {
					alert('기대효과가 입력되지 않았습니다');
					impact.focus();
					return;
				}
				if (content.val() == '') {
					alert('내용이 입력되지 않았습니다');
					content.focus();
					return;
				}
				if (start.val() == '') {
					alert('챌린지 종료 날짜가 입력되지 않았습니다');
					start.focus();
					return;
				}
				if (end.val() == '') {
					alert('챌린지 종료 날짜가 입력되지 않았습니다');
					end.focus();
					return;
				}
				if (howTo1.val() == '') {
					alert('방법1이 입력되지 않았습니다');
					howTo1.focus();
					return;
				}
				if (howTo2.val() == '') {
					alert('방법2가 입력되지 않았습니다');
					howTo2.focus();
					return;
				}
				
				
				//사진
				var formData = new FormData(document.insertForm); //FormData 객체 생성

			 	$.ajax({
					url: '/challengeInsert',
					type: 'POST',
					processData: false, //기본값은 true, ajax 통신을 통해 데이터를 전송할 때, 기본적으로 key와 value값을 Query String으로 변환해서 보냅니다.
					contentType: false, // multipart/form-data타입을 사용하기위해 false 로 지정합니다.
					data: formData,
					success: function (result) {
						console.log(result)
						alert('성공!')
						location.href='/challengeList'
	
					},
					error: function (reject) {
						alert('실패입니다!')
						console.log(reject);
					}
			    }); 

			}
			
			document.querySelectorAll('.file-input').forEach(function(input) {
			    input.addEventListener('change', function(event) {
			        var files = event.target.files;
			        var imageContainers = document.querySelectorAll('.image-container');
			        
			        for (var i = 0; i < files.length; i++) {
			            var file = files[i];
			            var label = input.nextElementSibling;
			            var fileChosen = input.nextElementSibling.nextElementSibling;

			            if (file) {
			                label.textContent = '파일 선택';
			                fileChosen.textContent = file.name;

			                // 이미지 미리보기 기능
			                var reader = new FileReader();
			                reader.onloadend = (function (imgContainer) {
			                    return function (e) {
			                        imgContainer.querySelector('.showimg-container img').src = e.target.result;
			                    };
			                })(imageContainers[i]);
			                reader.readAsDataURL(file);
			            } else {
			                label.textContent = '파일 선택';
			                fileChosen.textContent = '파일명';
			            }
			        }
			    });
			});
		</script>

	</section>
</body>
</html>